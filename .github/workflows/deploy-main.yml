name: Deploy – Production

on:
  push:
    branches:
      - main

env:
  BACKEND_IMAGE: tyash26/backend
  FRONTEND_IMAGE: tyash26/frontend
  TAG: latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build backend
        run: docker build -t $BACKEND_IMAGE:$TAG ./backend

      - name: Push backend
        run: docker push $BACKEND_IMAGE:$TAG

      # - name: Build frontend
      #   run: |
      #     docker build \
      #       --build-arg NEXT_PUBLIC_API_URL=http://${{ secrets.PROD_HOST }}:${{ secrets.PROD_PORT }}/api \
      #       --build-arg NEXT_PUBLIC_SOCKET_URL=http://${{ secrets.PROD_HOST }}:${{ secrets.PROD_PORT }} \
      #       -t $FRONTEND_IMAGE:$TAG \
      #       ./frontend

      - name: Build frontend
        run: docker build -t $FRONTEND_IMAGE:$TAG ./frontend

      - name: Push frontend
        run: docker push $FRONTEND_IMAGE:$TAG

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    steps:
      - name: Deploy on Server
        run: |
          sudo mkdir -p /opt/mdm
          sudo chown -R $USER:$USER /opt/mdm

          cd /opt/mdm || exit 1

          docker pull tyash26/backend:latest
          docker pull tyash26/frontend:latest
          docker pull nginx:alpine



          docker compose -f docker/docker-compose.prod.yml up -d --remove-orphans

          docker image prune -f

 # docker-compose -f docker/docker-compose.prod.yml down || true
# docker-compose -f docker/docker-compose.prod.yml up -d
# docker exec mdm_backend npx prisma db push
# docker exec mdm_backend node dist/prisma/seed.js

# ├── .github/
# │   └── workflows/
# │       ├── ci-feature.yml          # feature/* → lint + test
# │       ├── deploy-develop.yml      # develop → staging
# │       ├── deploy-release.yml      # release/* → pre-prod
# │       ├── deploy-main.yml         # main → production
# │       └── deploy-hotfix.yml       # hotfix/* → production

# name: Deploy – Production

# on:
#   push:
#     branches: [ main ]

# env:
#   BACKEND_IMAGE: tyash26/backend
#   FRONTEND_IMAGE: tyash26/frontend
#   TAG: latest

# jobs:
#   build-and-push:
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       - name: Build & Push Backend
#         run: |
#           docker build -t $BACKEND_IMAGE:$TAG ./backend
#           docker push $BACKEND_IMAGE:$TAG

#       - name: Build & Push Frontend
#         run: |
#           docker build \
#             --build-arg NEXT_PUBLIC_API_URL=/api \
#             --build-arg NEXT_PUBLIC_SOCKET_URL=/ \
#             -t $FRONTEND_IMAGE:$TAG \
#             ./frontend
#           docker push $FRONTEND_IMAGE:$TAG

#   deploy:
#     needs: build-and-push
#     runs-on: self-hosted

#     steps:
#       - name: Prepare folders
#         run: |
#           mkdir -p /opt/mdm/backend /opt/mdm/frontend
#           cd /opt/mdm

#       - name: Pull images
#         run: |
#           docker pull tyash26/backend:latest
#           docker pull tyash26/frontend:latest

#       - name: Create env files
#         run: |
#           cat <<EOF > /opt/mdm/backend/.env
#           NODE_ENV=production
#           DATABASE_URL=${{ secrets.DATABASE_URL }}
#           JWT_SECRET=${{ secrets.JWT_SECRET }}
#           REDIS_URL=${{ secrets.REDIS_URL }}
#           EOF

#           cat <<EOF > /opt/mdm/frontend/.env
#           NEXT_PUBLIC_API_URL=/api
#           NEXT_PUBLIC_SOCKET_URL=/
#           EOF

#       - name: Deploy containers
#         run: |
#           cd /opt/mdm
#           docker compose -f docker-compose.prod.yml up -d --remove-orphans

#       - name: Run Prisma init & seed (first run only)
#         run: |
#           if [ ! -f /opt/mdm/.prisma_initialized ]; then
#             echo "First deploy → running prisma db push + seed"

#             docker exec mdm_backend npx prisma db push
#             docker exec mdm_backend node dist/prisma/seed.js

#             touch /opt/mdm/.prisma_initialized
#           else
#             echo "Prisma already initialized — skipping"
#           fi

#       - name: Cleanup
#         run: docker image prune -f
