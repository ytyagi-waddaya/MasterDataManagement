generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------
// Enums
// ----------------------
enum RecordStatus { 
  Draft 
  Validation 
  Approval 
  Published 
  Archived
}
enum TaskStatus { 
  Pending 
  Completed 
  Rejected 
  Cancelled 
}

enum NotificationType { 
  INFO 
  WARNING 
  TASK_
  ASSIGNMENT 
  SYSTEM 
}

enum NotificationChannel { 
  IN_APP 
  EMAIL 
  PUSH 
  SMS 
}
enum PolicyEffect { 
  ALLOW 
  DENY 
}

// ----------------------
// Users & Roles
// ----------------------
model User {
  id            String         @id @default(uuid())
  tenantId      String?        
  name          String
  email         String         @unique
  password      String
  attributes    Json?                          // flexible attributes for ABAC
  // denormalized/structured attributes for fast filtering
  department    String?        
  location      String?        
  roles         UserRole[]
  taskAssignments TaskAssignment[]
  notifications Notification[] @relation("UserNotifications")
  createdRecords     MasterRecord[] @relation("UserCreatedRecords")
  createdBatches     NotificationBatch[] @relation("UserCreatedBatches")
  deliveries         NotificationDelivery[] @relation("UserDeliveries")
  // dynamicFormsCreated DynamicForm[] @relation("UserCreatedForms") // <- back-relation
  // formSubmissions DynamicFormSubmission[] @relation("UserFormSubmissions") // <- back-relation
  auditLogs     AuditLog[]
  createdAt     DateTime       @default(now()) 
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?

  @@index([tenantId])
  @@index([department])
  @@index([location])
  @@index([createdAt])
}

model Role {
  id            String           @id @default(uuid())
  tenantId      String?         
  name          String           @unique
  description   String?
  users         UserRole[]
  permissions   RolePermission[]
  // optional role hierarchy relations
  parents       RoleHierarchy[]  @relation("ParentRoles")
  children      RoleHierarchy[]  @relation("ChildRoles")
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([tenantId])
}

// Role inheritance (optional)
model RoleHierarchy {
  id        String @id @default(uuid())
  tenantId  String?
  parent    Role   @relation("ParentRoles", fields: [parentId], references: [id])
  parentId  String
  child     Role   @relation("ChildRoles", fields: [childId], references: [id])
  childId   String

  @@unique([parentId, childId])
  @@index([parentId])
  @@index([childId])
}

// mapping table
model UserRole {
  id        String   @id @default(uuid())
  tenantId  String?  
  user      User     @relation(fields: [userId], references: [id])
  userId    String   
  role      Role     @relation(fields: [roleId], references: [id])
  roleId    String   
  assignedAt DateTime @default(now())

  @@unique([userId, roleId])
  @@index([tenantId])
  @@index([userId])
  @@index([roleId])
}

// ----------------------
// Actions, Resources, Permissions
// ----------------------
model Action {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  permissions Permission[] // many-to-many via Permission -> RolePermission
  policies    Policy[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Resource {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  permissions Permission[]
  policies    Policy[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Permission {
  id           String     @id @default(uuid())
  tenantId     String?    
  action       Action     @relation(fields: [actionId], references: [id])
  actionId     String
  resource     Resource   @relation(fields: [resourceId], references: [id])
  resourceId   String
  // ABAC condition stored as Json (recommend jsonlogic / CEL)
  conditions   Json?
  // optional human readable expression
  expression   String?
  roles        RolePermission[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([actionId, resourceId])
  @@index([actionId])
  @@index([resourceId])
  @@index([tenantId])
}

// Role <-> Permission
model RolePermission {
  id           String     @id @default(uuid())
  tenantId     String?    
  role         Role       @relation(fields: [roleId], references: [id])
  roleId       String     
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId String     
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId, permissionId])
  @@index([tenantId])
}

// ----------------------
// Policies (first-class ABAC)
// ----------------------
model Policy {
  id          String       @id @default(uuid())
  tenantId    String?      
  description String?
  effect      PolicyEffect @default(ALLOW)
  // optional scoping to resource/action
  resource    Resource?    @relation(fields: [resourceId], references: [id])
  resourceId  String?
  action      Action?      @relation(fields: [actionId], references: [id])
  actionId    String?
  // condition expression as Json (jsonlogic/CEL). Required for ABAC.
  condition   Json
  // priority for conflict resolution (lower = higher priority)
  priority    Int          @default(100)
  enabled     Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([resourceId])
  @@index([actionId])
  @@index([enabled])
  @@index([tenantId])
}

// ----------------------
// Master Objects / Records / Workflows
// ----------------------
model MasterObject {
  id         String         @id @default(uuid())
  tenantId   String?        
  name       String         @unique
  fields     Json           // form/fields definition
  records    MasterRecord[]
  workflows  Workflow[]
  // dynamicForms DynamicForm[]  
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  deletedAt  DateTime?

  @@index([tenantId])
}

model MasterRecord {
  id             String         @id @default(uuid())
  tenantId       String?        
  masterObject   MasterObject   @relation(fields: [masterObjectId], references: [id])
  masterObjectId String
  data           Json
  status         RecordStatus   @default(Draft) 
  createdBy      User?          @relation("UserCreatedRecords", fields: [createdById], references: [id])
  createdById    String?
  tasks          Task[]
  auditLogs      AuditLog[]
    // formSubmissions DynamicFormSubmission[] @relation("MasterRecordSubmissions") // <- back-relation added
  createdAt      DateTime       @default(now()) 
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
}

// Workflows
model Workflow {
  id             String         @id @default(uuid())
  tenantId       String?        
  masterObject   MasterObject   @relation(fields: [masterObjectId], references: [id])
  masterObjectId String
  name           String
  steps          Json           // e.g., [{"name":"Validation","role":"Validator"}]
  tasks          Task[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([tenantId])
}

// Tasks (workflow runs)
model Task {
  id             String         @id @default(uuid())
  tenantId       String?        
  masterRecord   MasterRecord   @relation(fields: [masterRecordId], references: [id])
  masterRecordId String
  workflow       Workflow       @relation(fields: [workflowId], references: [id])
  workflowId     String
  currentStep    Json
  status         TaskStatus     @default(Pending) 
  assignedToId   String?
  createdAt      DateTime       @default(now()) 
  updatedAt      DateTime       @updatedAt
  // soft delete optional
  deletedAt      DateTime?

   assignees      TaskAssignment[]

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
}

model TaskAssignment {
  id        String   @id @default(uuid())
  task      Task     @relation(fields: [taskId], references: [id])
  taskId    String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  assignedAt DateTime @default(now())

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

// ----------------------
// Audit logs
// ----------------------
model AuditLog {
  id             String       @id @default(uuid())
  tenantId       String?      
  masterRecord   MasterRecord @relation(fields: [masterRecordId], references: [id])
  masterRecordId String
  user           User?        @relation(fields: [userId], references: [id])
  userId         String?
  action         String
  comment        String?
  step           Json?
  // snapshot (before & after) - useful for forensic auditing
  before         Json?
  after          Json?
  createdAt      DateTime     @default(now()) 

  @@index([tenantId])
  @@index([createdAt])
}

// ----------------------
// Notifications (template, batch, delivery)
// ----------------------
model NotificationTemplate {
  id          String   @id @default(uuid())
  tenantId    String?  
  name        String
  channel     NotificationChannel
  subject     String?
  body        String   // template body (can include handlebars/json)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

model NotificationBatch {
  id          String       @id @default(uuid())
  tenantId    String?      
  title       String
  message     String
  type        NotificationType @default(INFO)
  data        Json?
  createdBy   User?        @relation("UserCreatedBatches", fields: [createdById], references: [id])
  createdById String?
  createdAt   DateTime     @default(now())
  deliveries  NotificationDelivery[]

  @@index([tenantId])
}

model NotificationDelivery {
  id            String               @id @default(uuid())
  tenantId      String?              
  batch         NotificationBatch?   @relation(fields: [batchId], references: [id])
  batchId       String?
  user          User?                @relation("UserDeliveries", fields: [userId], references: [id])
  userId        String?              
  title         String
  message       String
  type          NotificationType     @default(INFO)
  channels      Json                 // e.g. ["IN_APP","EMAIL"]
  targetType    String?
  targetId      String?
  priority      Int                  @default(0)
  read          Boolean              @default(false) 
  createdAt     DateTime             @default(now()) 
  readAt        DateTime?
  sentAt        DateTime?
  deliveredAt   DateTime?
  failedAt      DateTime?
  retryCount    Int                  @default(0)
  lastError     String?
  scheduledAt   DateTime?

  @@index([tenantId])
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  
  

}

// Convenience single-row notifications (if you prefer direct creation)
model Notification {
  id          String   @id @default(uuid())
  tenantId    String?  
  user        User?    @relation("UserNotifications", fields: [userId], references: [id])
  userId      String?  
  title       String
  message     String
  type        NotificationType @default(INFO)
  channels    Json?
  data        Json?
  targetType  String?
  targetId    String?
  read        Boolean  @default(false) 
  createdAt   DateTime @default(now()) 
  readAt      DateTime?
  sentAt      DateTime?
  deletedAt   DateTime?

  @@index([tenantId])
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  
}



// ----------------------
// Dynamic Forms for Master Data
// ----------------------
// model DynamicForm {
//   id              String         @id @default(uuid())
//   tenantId        String?
//   masterObject    MasterObject   @relation(fields: [masterObjectId], references: [id])
//   masterObjectId  String
//   name            String
//   description     String?
//   status          RecordStatus   @default(Draft)
//   // fields          DynamicField[]
//   // submissions     DynamicFormSubmission[]
//   createdBy       User?          @relation("UserCreatedForms",fields: [createdById], references: [id])
//   createdById     String?
//   createdAt       DateTime       @default(now())
//   updatedAt       DateTime       @updatedAt

//   @@index([tenantId])
//   @@index([masterObjectId])
//   @@index([status])
// }

// model DynamicField {
//   id           String    @id @default(uuid())
//   form         DynamicForm @relation(fields: [formId], references: [id])
//   formId       String
//   label        String
//   type         String    // "text", "number", "select", "checkbox", "date", etc.
//   placeholder  String?
//   validations  Json?     // e.g., { "required": true, "regex": "^[a-zA-Z]+$" }
//   order        Int
//   dependsOnId  String?   // for cascading or conditional fields
//   options      DynamicFieldOption[]
//   conditions   Json?     // JSON logic for conditional rendering
//   createdAt    DateTime  @default(now())
//   updatedAt    DateTime  @updatedAt

//   @@index([formId])
//   @@index([dependsOnId])
//   @@index([order])
// }

// model DynamicFieldOption {
//   id        String       @id @default(uuid())
//   field     DynamicField @relation(fields: [fieldId], references: [id])
//   fieldId   String
//   label     String
//   value     String
//   order     Int?
//   createdAt DateTime     @default(now())
//   updatedAt DateTime     @updatedAt

//   @@index([fieldId])
// }

// model DynamicFormSubmission {
//   id        String       @id @default(uuid())
//   form      DynamicForm  @relation(fields: [formId], references: [id])
//   formId    String
//   masterRecord MasterRecord? @relation("MasterRecordSubmissions",fields: [masterRecordId], references: [id])
//   masterRecordId String?        // Optional link to your MasterRecord table
//   user      User?         @relation("UserFormSubmissions",fields: [userId], references: [id])
//   userId    String?
//   data      Json          // JSON: { fieldId: value }
//   status    RecordStatus  @default(Draft)
//   createdAt DateTime      @default(now())
//   updatedAt DateTime      @updatedAt

//   @@index([formId])
//   @@index([masterRecordId])
//   @@index([userId])
//   @@index([status])
// }
